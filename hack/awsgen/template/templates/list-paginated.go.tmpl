{{- define "output" }}
{{- if .IsLast }}
if err := resourceconverter.SendAllConverted(ctx, output, resourceConverter, {{ .IterVar }}.{{ .Current }}); err != nil {
	return err
}
{{- else }}
for _, {{ .NextIterVar }} := range {{ .IterVar }}.{{ .Current }} {
	{{- tabindent 1 (include "output" .Next) }}
}
{{- end }}
{{- end }}

func (p *{{.ProviderName}}) {{.FuncName}}(ctx context.Context, output chan<- model.Resource) error {
	client := {{.ServicePkg}}.NewFromConfig(p.config)

	input := &{{.ServicePkg}}.{{.Action}}Input{}

	paginator := {{.ServicePkg}}.New{{.Action}}Paginator(client, input)

	resourceConverter := p.converterFor({{ .ResourceName | quote }})
	for paginator.HasMorePages() {
		page, err := paginator.NextPage(ctx)
		if err != nil {
			return fmt.Errorf("failed to fetch {{.Description}}: %w", err)
		}

		{{ include "output" (.OutputKey.WithRoot "page") | tabindent 2 }}
	}

	return nil
}
